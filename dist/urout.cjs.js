"use strict";function t(t,e){if(t instanceof RegExp)return{keys:[],pattern:t};var r,s,n,h,a=[],i="",o=t.split("/");for(o[0]||o.shift();n=o.shift();)"*"===(r=n[0])?(a.push("wild"),i+="/(.*)"):":"===r?(s=n.indexOf("?",1),h=n.indexOf(".",1),a.push(n.substring(1,~s?s:~h?h:n.length)),i+=~s&&!~h?"(?:/([^/]+?))?":"/([^/]+?)",~h&&(i+=(~s?"?":"")+"\\"+n.substring(h))):i+="/"+n;return{keys:a,pattern:new RegExp("^"+i+(e?"(?=$|/)":"/?$"),"i")}}Object.defineProperty(exports,"__esModule",{value:!0}),exports[Symbol.toStringTag]="Module";var e=(t,e)=>{let r=t.url;if(null==r)return;let s=t._parsedUrl;if(s&&s.raw===r)return s;let n,h=r,a="";if(r.length>1){let s=r.indexOf("?",1);if(-1!==s&&(a=r.substring(s),h=r.substring(0,s),a.length>1&&(n=function(t,e,r,s){e=e||"&",r=r||"=";var n={};if("string"!=typeof t||0===t.length)return n;var h=/\+/g;t=t.split(e);var a=1e3;s&&"number"==typeof s.maxKeys&&(a=s.maxKeys);var i,o,l=t.length;a>0&&l>a&&(l=a);for(var d=0;d<l;++d){var u,p,c,f,g=t[d].replace(h,"%20"),m=g.indexOf(r);m>=0?(u=g.substr(0,m),p=g.substr(m+1)):(u=g,p=""),c=decodeURIComponent(u),f=decodeURIComponent(p),i=n,o=c,Object.prototype.hasOwnProperty.call(i,o)?Array.isArray(n[c])?n[c].push(f):n[c]=[n[c],f]:n[c]=f}return n}(a.substring(1)))),e&&!t._decoded&&(t._decoded=!0,-1!==h.indexOf("%")))try{h=decodeURIComponent(h)}catch(i){}}return t._parsedUrl={pathname:h,search:a,query:n,raw:r}};class r{constructor(t={}){this.mount=t=>t instanceof r?t.attach:t,this.routes=[],this.parse=e,this.handler=this.handler.bind(this),this.onError=t.onError||this.onErrorI,this.onNoMatch=t.onNoMatch||this.onError.bind(null,{code:404}),this.attach=(t,e)=>setTimeout(this.handler,0,t,e),this.all=this.add.bind(this,""),this.get=this.add.bind(this,"GET"),this.head=this.add.bind(this,"HEAD"),this.patch=this.add.bind(this,"PATCH"),this.options=this.add.bind(this,"OPTIONS"),this.connect=this.add.bind(this,"CONNECT"),this.delete=this.add.bind(this,"DELETE"),this.trace=this.add.bind(this,"TRACE"),this.post=this.add.bind(this,"POST"),this.put=this.add.bind(this,"PUT")}useI(e,...r){let s=[].concat.apply([],r),{keys:n,pattern:h}=t(e,!0);return this.routes.push({keys:n,pattern:h,method:"",handlers:s}),this}use(t,...e){return"/"===t?this.useI(t,e.map(this.mount)):"function"==typeof t||t instanceof r?this.useI("/",[t,...e].map(this.mount)):this.useI(t,((e,r,s)=>{if("string"==typeof t){let r=t.length;t.startsWith("/")||r++,e.url=e.url.substring(r)||"/",e.path=e.path.substring(r)||"/"}else e.url=e.url.replace(t,"")||"/",e.path=e.path.replace(t,"")||"/";"/"!==e.url.charAt(0)&&(e.url="/"+e.url),s()}),...e.map(this.mount),((t,e,r)=>{t.path=t._parsedUrl.pathname,t.url=t.path+t._parsedUrl.search,r()})),this}onErrorI(t,e,r){r.end(t.length&&t||t.message)}add(e,r,...s){let{keys:n,pattern:h}=t(r),a=[].concat.apply([],s);return this.routes.push({keys:n,pattern:h,method:e,handlers:a}),this}handler(t,e,r){let s=this.parse(t,!0),n=this.find(t.method,t.path=s.pathname);if(t.params=n.params,t.originalUrl=t.originalUrl||t.url,t.url=s.pathname+s.search,t.query=s.query||{},t.search=s.search,t.routePath=t.originalUrl,t.params){for(const[e,r]of Object.entries(t.params))t.routePath=t.routePath.replace(r,`:${e}`);t.routePath=t.routePath.replace(t.search,"")}try{let s=0,h=n.handlers.concat(this.onNoMatch),a=h.length,i=async()=>e.finished||s<a&&h[s++](t,e,r);(r=r||(s=>s?this.onError(s,t,e,r):i().catch(r)))()}catch(h){this.onError(h,t,e,r)}}find(t,e){let r,s,n="HEAD"===t,h=0,a=0,i=this.routes,o=[],l={},d=[];for(;h<i.length;h++)if(s=i[h],0===s.method.length||s.method===t||n&&"GET"===s.method)if(!1===s.keys){if(o=s.pattern.exec(e),null===o)continue;if(void 0!==o.groups)for(r in o.groups)l[r]=o.groups[r];s.handlers.length>1?d=d.concat(s.handlers):d.push(s.handlers[0])}else if(s.keys.length>0){if(o=s.pattern.exec(e),null===o)continue;for(a=0;a<s.keys.length;)l[s.keys[a]]=o[++a];s.handlers.length>1?d=d.concat(s.handlers):d.push(s.handlers[0])}else s.pattern.test(e)&&(s.handlers.length>1?d=d.concat(s.handlers):d.push(s.handlers[0]));return{params:l,handlers:d}}}exports.Router=r;
