!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).urout={})}(this,(function(t){"use strict";function e(t,e){if(t instanceof RegExp)return{keys:[],pattern:t};var s,r,n,h,i=[],a="",o=t.split("/");for(o[0]||o.shift();n=o.shift();)"*"===(s=n[0])?(i.push("wild"),a+="/(.*)"):":"===s?(r=n.indexOf("?",1),h=n.indexOf(".",1),i.push(n.substring(1,~r?r:~h?h:n.length)),a+=~r&&!~h?"(?:/([^/]+?))?":"/([^/]+?)",~h&&(a+=(~r?"?":"")+"\\"+n.substring(h))):a+="/"+n;return{keys:i,pattern:new RegExp("^"+a+(e?"(?=$|/)":"/?$"),"i")}}var s=(t,e)=>{let s=t.url;if(null==s)return;let r=t._parsedUrl;if(r&&r.raw===s)return r;let n,h=s,i="";if(s.length>1){let r=s.indexOf("?",1);if(-1!==r&&(i=s.substring(r),h=s.substring(0,r),i.length>1&&(n=function(t,e,s,r){e=e||"&",s=s||"=";var n={};if("string"!=typeof t||0===t.length)return n;var h=/\+/g;t=t.split(e);var i=1e3;r&&"number"==typeof r.maxKeys&&(i=r.maxKeys);var a,o,d=t.length;i>0&&d>i&&(d=i);for(var l=0;l<d;++l){var u,p,c,f,g=t[l].replace(h,"%20"),y=g.indexOf(s);y>=0?(u=g.substr(0,y),p=g.substr(y+1)):(u=g,p=""),c=decodeURIComponent(u),f=decodeURIComponent(p),a=n,o=c,Object.prototype.hasOwnProperty.call(a,o)?Array.isArray(n[c])?n[c].push(f):n[c]=[n[c],f]:n[c]=f}return n}(i.substring(1)))),e&&!t._decoded&&(t._decoded=!0,-1!==h.indexOf("%")))try{h=decodeURIComponent(h)}catch(a){}}return t._parsedUrl={pathname:h,search:i,query:n,raw:s}};class r{constructor(t={}){this.mount=t=>t instanceof r?t.attach:t,this.routes=[],this.parse=s,this.handler=this.handler.bind(this),this.onError=t.onError||this.onErrorI,this.onNoMatch=t.onNoMatch||this.onError.bind(null,{code:404}),this.attach=(t,e)=>setTimeout(this.handler,0,t,e),this.all=this.add.bind(this,""),this.get=this.add.bind(this,"GET"),this.head=this.add.bind(this,"HEAD"),this.patch=this.add.bind(this,"PATCH"),this.options=this.add.bind(this,"OPTIONS"),this.connect=this.add.bind(this,"CONNECT"),this.delete=this.add.bind(this,"DELETE"),this.trace=this.add.bind(this,"TRACE"),this.post=this.add.bind(this,"POST"),this.put=this.add.bind(this,"PUT")}useI(t,...s){let r=[].concat.apply([],s),{keys:n,pattern:h}=e(t,!0);return this.routes.push({keys:n,pattern:h,method:"",handlers:r}),this}use(t,...e){return"/"===t?this.useI(t,e.map(this.mount)):"function"==typeof t||t instanceof r?this.useI("/",[t,...e].map(this.mount)):this.useI(t,((e,s,r)=>{if("string"==typeof t){let s=t.length;t.startsWith("/")||s++,e.url=e.url.substring(s)||"/",e.path=e.path.substring(s)||"/"}else e.url=e.url.replace(t,"")||"/",e.path=e.path.replace(t,"")||"/";"/"!==e.url.charAt(0)&&(e.url="/"+e.url),r()}),...e.map(this.mount),((t,e,s)=>{t.path=t._parsedUrl.pathname,t.url=t.path+t._parsedUrl.search,s()})),this}onErrorI(t,e,s){s.end(t.length&&t||t.message)}add(t,s,...r){let{keys:n,pattern:h}=e(s),i=[].concat.apply([],r);return this.routes.push({keys:n,pattern:h,method:t,handlers:i}),this}handler(t,e,s){let r=this.parse(t,!0),n=this.find(t.method,t.path=r.pathname);t.params=n.params,t.originalUrl=t.originalUrl||t.url,t.url=r.pathname+r.search,t.query=r.query||{},t.search=r.search;try{let r=0,h=n.handlers.concat(this.onNoMatch),i=h.length,a=async()=>e.finished||r<i&&h[r++](t,e,s);(s=s||(r=>r?this.onError(r,t,e,s):a().catch(s)))()}catch(h){this.onError(h,t,e,s)}}find(t,e){let s,r,n="HEAD"===t,h=0,i=0,a=this.routes,o=[],d={},l=[];for(;h<a.length;h++)if(r=a[h],0===r.method.length||r.method===t||n&&"GET"===r.method)if(!1===r.keys){if(o=r.pattern.exec(e),null===o)continue;if(void 0!==o.groups)for(s in o.groups)d[s]=o.groups[s];r.handlers.length>1?l=l.concat(r.handlers):l.push(r.handlers[0])}else if(r.keys.length>0){if(o=r.pattern.exec(e),null===o)continue;for(i=0;i<r.keys.length;)d[r.keys[i]]=o[++i];r.handlers.length>1?l=l.concat(r.handlers):l.push(r.handlers[0])}else r.pattern.test(e)&&(r.handlers.length>1?l=l.concat(r.handlers):l.push(r.handlers[0]));return{params:d,handlers:l}}}t.Router=r,Object.defineProperty(t,"__esModule",{value:!0}),t[Symbol.toStringTag]="Module"}));
