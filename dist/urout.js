function t(t,e){if(t instanceof RegExp)return{keys:[],pattern:t};var n,r,s,i,h=[],a="",o=t.split("/");for(o[0]||o.shift();s=o.shift();)"*"===(n=s[0])?(h.push("wild"),a+="/(.*)"):":"===n?(r=s.indexOf("?",1),i=s.indexOf(".",1),h.push(s.substring(1,~r?r:~i?i:s.length)),a+=~r&&!~i?"(?:/([^/]+?))?":"/([^/]+?)",~i&&(a+=(~r?"?":"")+"\\"+s.substring(i))):a+="/"+s;return{keys:h,pattern:new RegExp("^"+a+(e?"(?=$|/)":"/?$"),"i")}}var e=function(t,e){var n=t.url;if(null!=n){var r=t._parsedUrl;if(r&&r._raw===n)return r;if(r={path:n,pathname:n,search:null,query:null,href:n,_raw:n},n.length>1){e&&!t._decoded&&~n.indexOf("%",1)&&(n=t.url=r.href=r.path=r.pathname=r._raw=decodeURIComponent(n),t._decoded=!0);var s=n.indexOf("?",1);-1!==s&&(r.search=n.substring(s),r.query=r.search.substring(1),r.pathname=n.substring(0,s),e&&r.query.length>0&&(r.query=function(t){for(var e,n={},s=r.query.split("&"),i=0,h=void 0,a=void 0;i<s.length;i++)a=void 0===(a=(e=s[i].split("="))[1])?"":a,n[h=e[0]]=void 0!==n[h]?[].concat(n[h],a):a;return n}()))}return t._parsedUrl=r}},n=function(t){var n=this;void 0===t&&(t={}),this.routes=[],this.parse=e,this.handler=this.handler.bind(this),this.onError=t.onError||this.onErrorI,this.onNoMatch=t.onNoMatch||this.onError.bind(null,{code:404}),this.attach=function(t,e){return setTimeout(n.handler,0,t,e)},this.all=this.add.bind(this,""),this.get=this.add.bind(this,"GET"),this.head=this.add.bind(this,"HEAD"),this.patch=this.add.bind(this,"PATCH"),this.options=this.add.bind(this,"OPTIONS"),this.connect=this.add.bind(this,"CONNECT"),this.delete=this.add.bind(this,"DELETE"),this.trace=this.add.bind(this,"TRACE"),this.post=this.add.bind(this,"POST"),this.put=this.add.bind(this,"PUT")};n.prototype.useI=function(e){for(var n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];var s=[].concat.apply([],n),i=t(e,!0);return this.routes.push({keys:i.keys,pattern:i.pattern,method:"",handlers:s}),this},n.prototype.use=function(t){for(var e,r,s,i=[],h=arguments.length-1;h-- >0;)i[h]=arguments[h+1];return"function"==typeof t?(e=this).useI.apply(e,["/",t].concat(i)):"/"===t?(r=this).useI.apply(r,[t].concat(i)):(s=this).useI.apply(s,[t,function(e,n,r){if("string"==typeof t){var s=t.length;0===t.indexOf("/")||s++,e.url=e.url.substring(s)||"/",e.path=e.path.substring(s)||"/"}else e.url=e.url.replace(t,"")||"/",e.path=e.path.replace(t,"")||"/";r()}].concat(i.map(function(t){return t instanceof n?t.attach:t}),[function(t,e,n){t.url=t._parsedUrl.href,t.path=t._parsedUrl.pathname,n()}])),this},n.prototype.onErrorI=function(t,e,n){n.statusCode=t.code||t.status||500,n.end(t.length&&t||t.message)},n.prototype.add=function(e,n){for(var r=[],s=arguments.length-2;s-- >0;)r[s]=arguments[s+2];var i=t(n),h=i.keys,a=i.pattern,o=[].concat.apply([],r);return this.routes.push({keys:h,pattern:a,method:e,handlers:o}),this},n.prototype.handler=function(t,e,n){var r=this,s=this.parse(t,!0),i=this.find(t.method,t.path=s.pathname);t.params=i.params,t.originalUrl=t.originalUrl||t.url,t.query=s.query||{},t.search=s.search;try{var h=0,a=i.handlers.concat(this.onNoMatch),o=a.length,d=function(){return e.finished||h<o&&a[h++](t,e,n)};n=n||function(s){return s?r.onError(s,t,e,n):d()},d()}catch(r){this.onError(r,t,e,n)}},n.prototype.find=function(t,e){for(var n,r,s="HEAD"===t,i=0,h=0,a=this.routes,o=[],d={},u=[];i<a.length;i++)if(0===(r=a[i]).method.length||r.method===t||s&&"GET"===r.method)if(0==r.keys.length){if(null===(o=r.pattern.exec(e)))continue;if(void 0!==o.groups)for(n in o.groups)d[n]=o.groups[n];r.handlers.length>1?u=u.concat(r.handlers):u.push(r.handlers[0])}else if(r.keys.length>0){if(null===(o=r.pattern.exec(e)))continue;for(h=0;h<r.keys.length;)d[r.keys[h]]=o[++h];r.handlers.length>1?u=u.concat(r.handlers):u.push(r.handlers[0])}else r.pattern.test(e)&&(r.handlers.length>1?u=u.concat(r.handlers):u.push(r.handlers[0]));return{params:d,handlers:u}},exports.Router=n;
